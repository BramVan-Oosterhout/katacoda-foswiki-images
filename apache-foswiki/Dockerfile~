# Filename: Dockerfile
FROM httpd:2.4

ENV PERL_MM_USE_DEFAULT 1

WORKDIR /tmp
RUN apt-get update
RUN apt-get install -y wget libarray-utils-perl make build-essential

RUN cpan -T install CGI CGI::Session Crypt::PasswdMD5 Error File::Copy::Recursive JSON

WORKDIR /var/www

# Download and extract Foswiki
RUN wget -O Foswiki-2.1.6.tgz https://github.com/foswiki/distro/releases/download/FoswikiRelease02x01x06/Foswiki-2.1.6.tgz
RUN tar -zxvf Foswiki-2.1.6.tgz 
RUN mv Foswiki-2.1.6 foswiki
RUN rm Foswiki-2.1.6.tgz

WORKDIR /var/www/foswiki

#configure Foswiki
RUN tools/configure -save -noprompt
RUN tools/configure -save -set {DefaultUrlHost}='http://[[HOST_SUBDOMAIN]]-80-[[KATACODA_HOST]].environments.katacoda.com'
RUN tools/configure -save -set {Password}='password'
RUN tools/configure -save -set {Sessions}{UseIPMatching}='0'
RUN touch data/.htpasswd
RUN chown -R daemon:daemon *

# Configure the httpd server
COPY foswiki.conf /usr/local/apache2/conf/extra/.
RUN sed -i '/# Supplemental configuration/a Include conf/extra/foswiki.conf' /usr/local/apache2/conf/httpd.conf
